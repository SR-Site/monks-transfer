#!/bin/bash

# executables
DRUSH_BIN="$(which drush)"
GRUNT_BIN="$(which grunt)"
NPM_BIN="$(which npm)"
RSYNC_BIN="$(which rsync)"
TSD_BIN="$(which tsd)"
GIT_BIN="$(which git)"
COMPOSER_BIN="$(which composer)"

#config
ROOTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}")/../../" && pwd )"
DRUSH_DIR="${ROOTDIR}/docroot"
GRUNT_DIR="${ROOTDIR}/tools/build"
COMPOSER_DIR="${ROOTDIR}/"
NPM_DIR="${ROOTDIR}/tools/build"
TSD_DIR="${ROOTDIR}/tools/build"
ASSETDIR="${ROOTDIR}docroot/sites/default/files"
FRONTEND_BUILDROOT="${ROOTDIR}/tools/build"
BACKEND_BUILDROOT=""
BLOCKDOCS="/var/www/block-docs/"
JOB_NAME="Spectrum-Reach"

#bootrap scripts

GIT_BRANCH_CURRENT=""

SCRIPTROOT=$( cd $(dirname "${BASH_SOURCE[0]}") && pwd)

source "${SCRIPTROOT}/jenkins-commands"

if [ "${1}" == "self-update" ]; then
	selfUpdate
	exit 0
fi

if [ "${GIT_BRANCH_CURRENT}" == "" ]; then
	GIT_BRANCH_CURRENT=${GIT_BRANCH}
fi

if [ "${1}" != "" ]; then
	GIT_BRANCH_CURRENT=${1}
fi

BUILDFILE="${GIT_BRANCH_CURRENT//origin\//}"
BUILDFILE="${BUILDFILE//\//_}"

if [ ! -e "${SCRIPTROOT}/builds/${BUILDFILE}" ]; then
	echo "No Build found for: ${GIT_BRANCH_CURRENT} - ${SCRIPTROOT}/builds/${BUILDFILE}"
	exit 1
fi

source ${SCRIPTROOT}/builds/${BUILDFILE}

changeDir "${ROOTDIR}"
echo ""	
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo "| Build frontend                                                                                                           |"
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo ""	
build_frontend
echo ""	
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo ""	

changeDir "${ROOTDIR}"
echo ""	
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo "| Build backend                                                                                                            |"
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo ""	
build_backend
echo ""	
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo ""	

changeDir "${ROOTDIR}"
echo ""	
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo "| Run deploy                                                                                                               |"
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo ""	
build_deploy
echo ""	
echo "+--------------------------------------------------------------------------------------------------------------------------+"
echo ""	